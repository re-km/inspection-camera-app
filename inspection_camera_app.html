<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>ã€æ¨ªå‘ãå°‚ç”¨ã€‘é«˜ç”»è³ªç‚¹æ¤œã‚«ãƒ¡ãƒ©</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.min.js"></script>
    <script async src="https://docs.opencv.org/4.9.0/opencv.js" id="opencv-js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/piexifjs/1.0.6/piexif.js"></script>
    <style>
        /* åŸºæœ¬ã‚¹ã‚¿ã‚¤ãƒ«: æ¨ªå‘ãå°‚ç”¨ */
        html, body, #app-container { height: 100%; width: 100%; margin: 0; overflow: hidden; font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        .section { height: 100vh; display: flex; flex-direction: column; }
        #capture-btn { width: 64px; height: 64px; border-radius: 50%; border: 5px solid white; background-color: rgba(255, 255, 255, 0.3); transition: background-color 0.2s; }
        #capture-btn:active { background-color: rgba(255, 255, 255, 0.6); }
        #photo-gallery { scrollbar-width: none; -ms-overflow-style: none; }
        #photo-gallery::-webkit-scrollbar { display: none; }
        #selection-box { position: absolute; border: 2px dashed #00aeff; background-color: rgba(0, 174, 255, 0.2); pointer-events: none; }
        #camera-frame { transition: box-shadow 0.3s ease-in-out; }
        .status-dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; }
        #camera-stream { width: 100%; height: 100%; object-fit: contain; }
    </style>
</head>
<body class="bg-gray-900 text-white">

    <div id="app-container" class="flex flex-row h-full">

        <!-- å·¦ã‚»ã‚¯ã‚·ãƒ§ãƒ³: PDFãƒ“ãƒ¥ãƒ¼ã‚¢ -->
        <div id="pdf-section" class="section w-1/2 p-2 bg-gray-800">
            <div class="flex-shrink-0">
                 <div class="flex flex-wrap gap-2 mb-2">
                    <label for="pdf-upload" class="flex-grow text-center cursor-pointer bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-3 rounded-lg text-sm">PDFé¸æŠ</label>
                    <button id="toggle-compare-btn" class="flex-grow text-center bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-3 rounded-lg text-sm">ğŸ–¼ï¸ æ¯”è¼ƒ</button>
                </div>
                 <input type="file" id="pdf-upload" class="hidden" accept=".pdf">
            </div>
            <div id="pdf-viewer-wrapper" class="flex-grow overflow-auto bg-gray-700 rounded-lg relative mt-1">
                <div id="pdf-viewer" class="w-full relative"></div>
                <div id="pdf-placeholder" class="absolute inset-0 flex items-center justify-center text-gray-400">PDFã‚’é¸æŠ</div>
                <div id="selection-box" class="hidden"></div>
            </div>
            <div id="pdf-controls" class="flex items-center justify-center mt-1 flex-shrink-0 hidden">
                <button id="prev-page" class="bg-gray-600 hover:bg-gray-500 font-bold py-1 px-3 rounded-l-lg">â—€</button>
                <span id="page-num" class="bg-gray-800 py-1 px-2 text-sm"></span>/<span id="page-count" class="bg-gray-800 py-1 px-2 text-sm"></span>
                <button id="next-page" class="bg-gray-600 hover:bg-gray-500 font-bold py-1 px-3 rounded-r-lg">â–¶</button>
            </div>
        </div>

        <!-- å³ã‚»ã‚¯ã‚·ãƒ§ãƒ³: ã‚«ãƒ¡ãƒ©ã¨æ’®å½±çµæœ -->
        <div id="camera-section" class="section w-1/2 p-2 bg-gray-900">
            <div id="camera-frame" class="relative flex-grow bg-black rounded-lg mb-2">
                <video id="camera-stream" autoplay playsinline></video>
                <div id="match-indicator" class="hidden absolute top-2 right-2 bg-green-500 text-white font-bold text-sm px-3 py-1 rounded-full shadow-lg z-20"></div>
                <div class="absolute top-2 left-2 bg-black bg-opacity-50 p-1 rounded-md text-xs z-20">
                    <div><span id="gps-status-dot" class="status-dot bg-red-500"></span> GPS</div>
                    <div><span id="compass-status-dot" class="status-dot bg-red-500"></span> æ–¹ä½</div>
                </div>
                <div class="absolute bottom-4 left-1/2 -translate-x-1/2 z-10">
                    <button id="capture-btn" title="æ’®å½±"></button>
                </div>
            </div>
            <div class="flex-shrink-0 h-24">
                <div id="target-image-container" class="mb-1 hidden items-center space-x-2">
                    <img id="target-image" class="h-12 border-2 border-teal-500 rounded-md inline-block">
                    <button id="ai-assistant-btn" class="bg-fuchsia-600 hover:bg-fuchsia-700 text-white font-bold py-2 px-3 rounded-lg text-sm">âœ¨ AIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ</button>
                </div>
                <div id="photo-gallery" class="h-full bg-gray-800 rounded-lg p-2 flex space-x-2 overflow-x-auto">
                    <div id="gallery-placeholder" class="w-full h-full flex items-center justify-center text-gray-500">æ’®å½±å†™çœŸ</div>
                </div>
            </div>
        </div>
    </div>

    <!-- å„ç¨®éè¡¨ç¤ºè¦ç´  -->
    <canvas id="capture-canvas" class="hidden"></canvas>
    <div id="gemini-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 p-4">
        <div class="bg-gray-800 rounded-lg p-6 w-11/12 max-w-3xl text-white shadow-2xl max-h-[90vh] flex flex-col">
            <h3 id="modal-title" class="text-2xl font-bold mb-4 flex items-center flex-shrink-0"></h3>
            <div class="overflow-y-auto pr-4">
                <div id="gemini-modal-content" class="min-h-[100px]"></div>
                <div id="report-generation-area" class="mt-6 hidden">
                    <h4 class="text-xl font-semibold border-t border-gray-600 pt-4">å ±å‘Šæ›¸ï¼ˆæ¡ˆï¼‰</h4>
                    <div id="report-content" class="mt-2 p-4 bg-gray-900 rounded-lg min-h-[150px] whitespace-pre-wrap"></div>
                    <div class="text-right mt-2">
                         <button id="copy-report-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg">æ–‡ç« ã‚’ã‚³ãƒ”ãƒ¼</button>
                    </div>
                </div>
            </div>
            <div class="mt-6 text-right flex-shrink-0">
                <button id="close-modal-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg">é–‰ã˜ã‚‹</button>
            </div>
        </div>
    </div>

    <script>
    // --- ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã¨è¦ç´ å–å¾— ---
    const elements = {};
    let pdfDoc = null, currentPageNum = 1, pageIsRendering = false, pageNumIsPending = null;
    let isCompareMode = false, isSelecting = false;
    let selectionStart = { x: 0, y: 0 };
    let targetImageDataUrl = null;
    let frameCount = 0;
    const MATCH_THRESHOLD = 0.7;
    let cv = null;
    const sensorData = { latitude: null, longitude: null, heading: null };

    // --- ãƒ¡ã‚¤ãƒ³åˆæœŸåŒ–å‡¦ç† ---
    document.addEventListener('DOMContentLoaded', () => {
        const ids = ['pdf-upload', 'pdf-viewer', 'pdf-placeholder', 'pdf-controls', 'prev-page', 'next-page', 'page-num', 'page-count', 'camera-stream', 'capture-btn', 'capture-canvas', 'photo-gallery', 'gallery-placeholder', 'gemini-modal', 'gemini-modal-content', 'close-modal-btn', 'toggle-compare-btn', 'selection-box', 'target-image-container', 'target-image', 'camera-frame', 'match-indicator', 'opencv-js', 'gps-status-dot', 'compass-status-dot', 'report-generation-area', 'report-content', 'copy-report-btn', 'pdf-viewer-wrapper', 'modal-title', 'ai-assistant-btn'];
        ids.forEach(id => { elements[id] = document.getElementById(id); });
        
        initEventListeners();
        initCamera();
        initSensors();

        if (elements['opencv-js']) {
            elements['opencv-js'].onload = () => {
                let checkCvInterval = setInterval(() => {
                    if (window.cv && window.cv.imread) {
                        clearInterval(checkCvInterval);
                        cv = window.cv;
                        console.log('OpenCV.js is ready.');
                        requestAnimationFrame(comparisonLoop);
                    }
                }, 100);
            };
        }
    });

    // --- PDFé–¢é€£ ---
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.worker.min.js';
    function renderPage(num) { /* ... (å®Ÿè£…ã¯å¤‰æ›´ãªã—ã®ãŸã‚çœç•¥) ... */ }
    function queueRenderPage(num) { /* ... (å®Ÿè£…ã¯å¤‰æ›´ãªã—ã®ãŸã‚çœç•¥) ... */ }

    // --- ã‚»ãƒ³ã‚µãƒ¼é–¢é€£ (GPS, æ–¹ä½) ---
    function initSensors() { /* ... (å®Ÿè£…ã¯å¤‰æ›´ãªã—ã®ãŸã‚çœç•¥) ... */ }
    function handleOrientation(event) { /* ... (å®Ÿè£…ã¯å¤‰æ›´ãªã—ã®ãŸã‚çœç•¥) ... */ }

    // --- ã‚«ãƒ¡ãƒ©é–¢é€£ (4:3å¯¾å¿œ) ---
    async function initCamera() { /* ... (å®Ÿè£…ã¯å¤‰æ›´ãªã—ã®ãŸã‚çœç•¥) ... */ }
    async function takePicture() { /* ... (å®Ÿè£…ã¯å¤‰æ›´ãªã—ã®ãŸã‚çœç•¥) ... */ }
    function addToGallery(dataUrl) { /* ... (å®Ÿè£…ã¯å¤‰æ›´ãªã—ã®ãŸã‚çœç•¥) ... */ }

    // --- AIé–¢é€£ ---
    // æ’®å½±å†™çœŸã®æå‚·åˆ†æ
    async function analyzeImageWithGemini(dataUrl) {
        elements['modal-title'].innerHTML = `<span class="text-2xl mr-2">âœ¨</span> AIã«ã‚ˆã‚‹æå‚·åˆ†æ`;
        elements['gemini-modal'].classList.remove('hidden');
        elements['report-generation-area'].classList.add('hidden'); 
        elements['gemini-modal-content'].innerHTML = `<div class="flex flex-col justify-center items-center py-8"><div class="animate-spin rounded-full h-16 w-16 border-b-2 border-white"></div><p class="text-center mt-4">AIãŒåˆ†æä¸­ã§ã™...</p></div>`;
        try {
            const apiKey = "";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
            const base64ImageData = dataUrl.split(',')[1];
            const prompt = "ã“ã®ç”»åƒã¯æ§‹é€ ç‰©ã®ç‚¹æ¤œæ™‚ã«æ’®å½±ã•ã‚ŒãŸã‚‚ã®ã§ã™ã€‚ã‚³ãƒ³ã‚¯ãƒªãƒ¼ãƒˆã®ã²ã³å‰²ã‚Œã€å‰¥é›¢ã€é‰„ç­‹ã®éœ²å‡ºã€æ¼æ°´ã€éŒ†ãªã©ã®æå‚·ã®å¯èƒ½æ€§ã‚’åˆ†æã—ã€ç™ºè¦‹ã—ãŸç‚¹ã‚’ç®‡æ¡æ›¸ãã§ç°¡æ½”ã«èª¬æ˜ã—ã¦ãã ã•ã„ã€‚æå‚·ãŒè¦‹ã‚‰ã‚Œãªã„å ´åˆã¯ã€Œç‰¹ã«å•é¡Œã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚ã€ã¨å›ç­”ã—ã¦ãã ã•ã„ã€‚æ—¥æœ¬èªã§å›ç­”ã—ã¦ãã ã•ã„ã€‚";
            const payload = { contents: [{ role: "user", parts: [{ text: prompt }, { inlineData: { mimeType: "image/jpeg", data: base64ImageData } }] }] };
            const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
            if (!response.ok) throw new Error(`API Error: ${response.status} ${response.statusText}`);
            const result = await response.json();
            let analysisText = "åˆ†æçµæœã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚";
            if (result.candidates?.[0]?.content?.parts?.[0]?.text) { analysisText = result.candidates[0].content.parts[0].text; }
            elements['gemini-modal-content'].innerHTML = `<h4 class="text-xl font-semibold">åˆ†æçµæœ</h4><div id="gemini-modal-result" class="mt-2 p-4 bg-gray-900 rounded-lg">${analysisText.replace(/\n/g, '<br>')}</div>`;
            const generateBtn = document.createElement('button');
            generateBtn.innerHTML = `âœ¨ å ±å‘Šæ›¸ã‚’ä½œæˆ`;
            generateBtn.className = 'mt-4 bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg';
            generateBtn.onclick = () => generateReportFromAnalysis(analysisText);
            elements['gemini-modal-content'].appendChild(generateBtn);
        } catch (error) {
            console.error("Gemini API Error:", error);
            elements['gemini-modal-content'].innerHTML = `<p class="text-red-400">åˆ†æä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚</p><p class="text-xs text-gray-400 mt-2">${error.message}</p>`;
        }
    }
    // åˆ†æçµæœã‹ã‚‰å ±å‘Šæ›¸ã‚’ä½œæˆ
    async function generateReportFromAnalysis(analysisText) { /* ... (å®Ÿè£…ã¯å¤‰æ›´ãªã—ã®ãŸã‚çœç•¥) ... */ }
    
    // âœ¨ æ–°æ©Ÿèƒ½: AIæ’®å½±ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ
    async function getAiShootingAssistant(dataUrl) {
        elements['modal-title'].innerHTML = `<span class="text-2xl mr-2">âœ¨</span> AIæ’®å½±ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ`;
        elements['gemini-modal'].classList.remove('hidden');
        elements['report-generation-area'].classList.add('hidden');
        elements['gemini-modal-content'].innerHTML = `<div class="flex flex-col justify-center items-center py-8"><div class="animate-spin rounded-full h-16 w-16 border-b-2 border-white"></div><p class="text-center mt-4">AIãŒå†™çœŸã‚’ç¢ºèªã—ã¦ã„ã¾ã™...</p></div>`;
        
        try {
            const apiKey = "";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
            const base64ImageData = dataUrl.split(',')[1];
            const prompt = `ã‚ãªãŸã¯çµŒé¨“è±Šå¯ŒãªåœŸæœ¨æŠ€è¡“è€…ã§ã™ã€‚ã“ã®å†™çœŸã¯éå»ã®ç‚¹æ¤œã§æ’®å½±ã•ã‚ŒãŸã‚‚ã®ã§ã™ã€‚
1.  ã“ã®å†™çœŸã«å†™ã£ã¦ã„ã‚‹æ§‹é€ ç‰©ã‚„éƒ¨æãŒä½•ã§ã‚ã‚‹ã‹ã€å°‚é–€ç”¨èªã‚’ä½¿ã„ã¤ã¤ç°¡æ½”ã«èª¬æ˜ã—ã¦ãã ã•ã„ã€‚
2.  ã“ã®å¾Œã€æ–°äººæŠ€è¡“è€…ãŒåŒã˜å†™çœŸã‚’æ’®å½±ã—ã¾ã™ã€‚åŒã˜ã‚¢ãƒ³ã‚°ãƒ«ã‚„æ§‹å›³ã§æ’®å½±ã™ã‚‹ãŸã‚ã®ã€å…·ä½“çš„ã§åˆ†ã‹ã‚Šã‚„ã™ã„ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’ã—ã¦ãã ã•ã„ã€‚

ç¾åœ¨åœ°ã¯æ—¥æœ¬ã®ç¦äº•çœŒè¶Šå‰å¸‚ã§ã™ã€‚ç·¯åº¦ã¯${sensorData.latitude || 'ä¸æ˜'}ã€çµŒåº¦ã¯${sensorData.longitude || 'ä¸æ˜'}ã§ã™ã€‚ã“ã‚Œã‚‰ã®æƒ…å ±ã‚‚å‚è€ƒã«ã€å›ç­”ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚

ä¾‹ï¼š
**èª¬æ˜:** ã“ã‚Œã¯æ©‹å°ã®å´é¢ã¨ã‚¦ã‚£ãƒ³ã‚°ï¼ˆè¢–å£ï¼‰ã®æ¥åˆéƒ¨ã§ã™ã€‚
**æ’®å½±ã‚¢ãƒ‰ãƒã‚¤ã‚¹:** æ©‹å°ã‹ã‚‰ç´„5mé›¢ã‚Œã€å·ã®ä¸‹æµå´ã‹ã‚‰ä¸Šæµå´ã‚’å‘ã„ã¦æ’®å½±ã—ã¦ãã ã•ã„ã€‚å¤ªé™½ãŒèƒŒã«ãªã‚‹åˆå‰ä¸­ãŒæ¨å¥¨ã§ã™ã€‚`;

            const payload = { contents: [{ role: "user", parts: [{ text: prompt }, { inlineData: { mimeType: "image/jpeg", data: base64ImageData } }] }] };
            const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
            if (!response.ok) throw new Error(`API Error: ${response.status} ${response.statusText}`);
            const result = await response.json();
            let assistantText = "AIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã‹ã‚‰ã®ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚";
            if (result.candidates?.[0]?.content?.parts?.[0]?.text) {
                assistantText = result.candidates[0].content.parts[0].text;
            }
            elements['gemini-modal-content'].innerHTML = `<div class="prose prose-invert max-w-none">${assistantText.replace(/\n/g, '<br>')}</div>`;

        } catch (error) {
            console.error("AI Assistant Error:", error);
            elements['gemini-modal-content'].innerHTML = `<p class="text-red-400">AIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã®å‘¼ã³å‡ºã—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚</p>`;
        }
    }


    // --- ç”»åƒæ¯”è¼ƒé–¢é€£ ---
    function comparisonLoop() { /* ... (å®Ÿè£…ã¯å¤‰æ›´ãªã—ã®ãŸã‚çœç•¥) ... */ }

    // --- ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®ç™»éŒ² ---
    function initEventListeners() {
        elements['capture-btn'].addEventListener('click', takePicture);
        elements['ai-assistant-btn'].addEventListener('click', () => {
            if (targetImageDataUrl) {
                getAiShootingAssistant(targetImageDataUrl);
            }
        });
        
        elements['pdf-upload'].addEventListener('change', e => {
            const file = e.target.files[0];
            if (!file || file.type !== 'application/pdf') return;
            const fileReader = new FileReader();
            fileReader.onload = function() {
                const typedarray = new Uint8Array(this.result);
                pdfjsLib.getDocument(typedarray).promise.then(pdf => {
                    pdfDoc = pdf;
                    elements['page-count'].textContent = pdfDoc.numPages;
                    currentPageNum = 1;
                    renderPage(currentPageNum);
                    elements['pdf-controls'].classList.remove('hidden');
                    elements['pdf-placeholder'].classList.add('hidden');
                });
            };
            fileReader.readAsArrayBuffer(file);
        });
        
        // ... (ä»–ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã¯çœç•¥) ...
    }
    
    // --- çœç•¥ã—ãŸé–¢æ•°ã®å®Œå…¨ãªå®Ÿè£… ---
    // ... (ã“ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã«ã¯å‰ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‹ã‚‰å¤‰æ›´ã®ãªã„ã€è©³ç´°ãªé–¢æ•°å®Ÿè£…ãŒå«ã¾ã‚Œã¾ã™) ...
    renderPage = (num) => {
        pageIsRendering = true; if (!pdfDoc) return;
        pdfDoc.getPage(num).then(page => {
            const container = elements['pdf-viewer-wrapper']; if (!container) return;
            const viewport = page.getViewport({ scale: 1.5 }); const scale = container.clientWidth / viewport.width;
            const scaledViewport = page.getViewport({ scale: scale }); const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d'); canvas.height = scaledViewport.height; canvas.width = scaledViewport.width;
            elements['pdf-viewer'].innerHTML = ''; elements['pdf-viewer'].appendChild(canvas);
            const renderContext = { canvasContext: context, viewport: scaledViewport };
            page.render(renderContext).promise.then(() => {
                pageIsRendering = false; if (pageNumIsPending !== null) { renderPage(pageNumIsPending); pageNumIsPending = null; }
            });
        });
        elements['page-num'].textContent = num;
    };
    queueRenderPage = (num) => { if (pageIsRendering) { pageNumIsPending = num; } else { renderPage(num); } };
    initSensors = () => { if ('geolocation' in navigator) { navigator.geolocation.watchPosition((p) => { sensorData.latitude = p.coords.latitude; sensorData.longitude = p.coords.longitude; elements['gps-status-dot'].classList.replace('bg-red-500', 'bg-green-500'); }, (e) => { console.warn(`GPSã‚¨ãƒ©ãƒ¼: ${e.message}`); elements['gps-status-dot'].classList.replace('bg-green-500', 'bg-red-500'); }, { enableHighAccuracy: true }); } if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') { DeviceOrientationEvent.requestPermission().then(p => { if (p === 'granted') window.addEventListener('deviceorientationabsolute', handleOrientation, true); else alert('æ–¹ä½ã‚»ãƒ³ã‚µãƒ¼ã®è¨±å¯ãŒå¿…è¦ã§ã™ã€‚'); }).catch(console.error); } else { window.addEventListener('deviceorientationabsolute', handleOrientation, true); } };
    handleOrientation = (event) => { if (event.alpha !== null) { sensorData.heading = event.alpha; elements['compass-status-dot'].classList.replace('bg-red-500', 'bg-green-500'); } else { elements['compass-status-dot'].classList.replace('bg-green-500', 'bg-red-500'); } };
    initCamera = async () => { try { const constraints = { video: { facingMode: 'environment', width: { ideal: 4032 }, height: { ideal: 3024 }, aspectRatio: { ideal: 4 / 3 } }, audio: false }; const stream = await navigator.mediaDevices.getUserMedia(constraints); elements['camera-stream'].srcObject = stream; } catch (err) { try { const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } }); elements['camera-stream'].srcObject = stream; } catch (e) { alert("ã‚«ãƒ¡ãƒ©ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚"); } } };
    takePicture = async () => { const video = elements['camera-stream']; const canvas = elements['capture-canvas']; canvas.width = video.videoWidth; canvas.height = video.videoHeight; canvas.getContext('2d').drawImage(video, 0, 0, canvas.width, canvas.height); const imageDataUrl = canvas.toDataURL('image/jpeg', 1.0); if (sensorData.latitude === null || sensorData.longitude === null || sensorData.heading === null) { console.warn("ã‚»ãƒ³ã‚µãƒ¼ãƒ‡ãƒ¼ã‚¿ä¸ååˆ†ã®ãŸã‚EXIFãªã—"); addToGallery(imageDataUrl); return; } const zeroth = {}; const gps = {}; zeroth[piexif.ImageIFD.Make] = "Inspection Camera App"; gps[piexif.GPSIFD.GPSLatitudeRef] = sensorData.latitude < 0 ? 'S' : 'N'; gps[piexif.GPSIFD.GPSLatitude] = piexif.GPSHelper.degToDms(Math.abs(sensorData.latitude)); gps[piexif.GPSIFD.GPSLongitudeRef] = sensorData.longitude < 0 ? 'W' : 'E'; gps[piexif.GPSIFD.GPSLongitude] = piexif.GPSHelper.degToDms(Math.abs(sensorData.longitude)); gps[piexif.GPSIFD.GPSImgDirectionRef] = "T"; gps[piexif.GPSIFD.GPSImgDirection] = [Math.round(sensorData.heading), 1]; const exifObj = {"0th":zeroth, "Exif":{}, "GPS":gps, "1st":{}, "thumbnail":null}; const exifbytes = piexif.dump(exifObj); addToGallery(piexif.insert(exifbytes, imageDataUrl)); };
    addToGallery = (dataUrl) => { elements['gallery-placeholder'].classList.add('hidden'); const photoWrapper = document.createElement('div'); photoWrapper.className = 'relative w-24 h-20 flex-shrink-0 group'; const img = document.createElement('img'); img.src = dataUrl; img.className = 'w-full h-full object-cover rounded-md'; const overlay = document.createElement('div'); overlay.className = 'absolute inset-0 bg-black bg-opacity-60 flex flex-col items-center justify-center opacity-0 group-hover:opacity-100 p-1'; const downloadLink = document.createElement('a'); downloadLink.href = dataUrl; downloadLink.download = `inspection-photo-${Date.now()}.jpg`; downloadLink.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="white" viewBox="0 0 256 256"><path d="M208,152v48a8,8,0,0,1-8,8H56a8,8,0,0,1-8-8V152a8,8,0,0,1,16,0v40H192V152a8,8,0,0,1,16,0ZM128,16a8,8,0,0,0-8,8V124.69L95.51,100.2a8,8,0,0,0-11,11.6l32,32a8,8,0,0,0,11,0l32-32a8,8,0,0,0-11-11.6L136,124.69V24A8,8,0,0,0,128,16Z"></path></svg>`; overlay.appendChild(downloadLink); const analyzeButton = document.createElement('button'); analyzeButton.innerHTML = `âœ¨`; analyzeButton.title = "AIã§åˆ†æ"; analyzeButton.className = "text-xl mt-1"; analyzeButton.onclick = () => analyzeImageWithGemini(dataUrl); overlay.appendChild(analyzeButton); photoWrapper.appendChild(img); photoWrapper.appendChild(overlay); elements['photo-gallery'].appendChild(photoWrapper); elements['photo-gallery'].scrollLeft = elements['photo-gallery'].scrollWidth; };
    generateReportFromAnalysis = async (analysisText) => { elements['report-generation-area'].classList.remove('hidden'); elements['report-content'].innerHTML = `<div class="flex items-center justify-center h-full"><div class="animate-spin rounded-full h-8 w-8 border-b-2 border-white"></div><p class="ml-4">å ±å‘Šæ›¸ã‚’ä½œæˆä¸­...</p></div>`; try { const apiKey = ""; const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`; const prompt = `ã‚ãªãŸã¯åœŸæœ¨æŠ€è¡“ã®å°‚é–€å®¶ã¨ã—ã¦ã€æ§‹é€ ç‰©ã®ç‚¹æ¤œå ±å‘Šæ›¸ã‚’ä½œæˆã—ã¦ã„ã¾ã™ã€‚ä»¥ä¸‹ã®å†™çœŸåˆ†æçµæœã«åŸºã¥ãã€æ‰€è¦‹ã€è©•ä¾¡ã€ãŠã‚ˆã³æ¨å¥¨ã•ã‚Œã‚‹æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ï¼ˆä¾‹ï¼šã€Œè©³ç´°èª¿æŸ»ãŒå¿…è¦ã€ã€ŒçµŒéè¦³å¯Ÿã€ã€Œè»½å¾®ãªè£œä¿®ã€ãªã©ï¼‰ã‚’å«ã‚€ã€è©³ç´°ã§å°‚é–€çš„ãªå ±å‘Šæ›¸ã®æ–‡ç« ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚\n\n### åˆ†æçµæœ\n${analysisText}\n\n### å ±å‘Šæ›¸ï¼ˆæ¡ˆï¼‰\n`; const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] }; const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) }); if (!response.ok) throw new Error(`API Error: ${response.status} ${response.statusText}`); const result = await response.json(); let reportText = "å ±å‘Šæ›¸ã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚"; if (result.candidates?.[0]?.content?.parts?.[0]?.text) { reportText = result.candidates[0].content.parts[0].text; } elements['report-content'].textContent = reportText; } catch (error) { console.error("Report Generation Error:", error); elements['report-content'].innerHTML = `<p class="text-red-400">å ±å‘Šæ›¸ã®ä½œæˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚</p>`; } };
    comparisonLoop = () => { if (cv && isCompareMode && targetImageDataUrl && elements['camera-stream'].readyState === 4) { frameCount++; if (frameCount % 3 === 0) { try { let src = cv.imread(elements['camera-stream']); let templ = cv.imread(elements['target-image']); let result = new cv.Mat(); let mask = new cv.Mat(); cv.matchTemplate(src, templ, result, cv.TM_CCOEFF_NORMED, mask); let resultData = cv.minMaxLoc(result, mask); let maxVal = resultData.maxVal; if (maxVal > MATCH_THRESHOLD) { elements['camera-frame'].style.boxShadow = `0 0 20px 5px rgba(25, 255, 25, 0.8)`; elements['match-indicator'].textContent = `ä¸€è‡´ç‡: ${Math.round(maxVal * 100)}%`; elements['match-indicator'].classList.remove('hidden'); } else { elements['camera-frame'].style.boxShadow = 'none'; elements['match-indicator'].classList.add('hidden'); } src.delete(); templ.delete(); result.delete(); mask.delete(); } catch (err) { elements['camera-frame'].style.boxShadow = 'none'; elements['match-indicator'].classList.add('hidden'); } } } else { elements['camera-frame'].style.boxShadow = 'none'; elements['match-indicator'].classList.add('hidden'); } requestAnimationFrame(comparisonLoop); };

    </script>
</body>
</html>
